<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‹å¸å—é€ƒé¦™æ¸¯è·¯ç·šåœ–</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Google Fonts (Noto Serif TC for historical feel) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Serif TC', serif;
            margin: 0;
            padding: 0;
            background-color: #f4f1ea; /* Parchment-like background */
            color: #3e2723;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background-color: #5d4037;
            color: #fff;
            padding: 10px 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
            letter-spacing: 2px;
        }

        #map-container {
            flex: 1;
            position: relative;
            z-index: 1;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        #controls {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-top: 1px solid #8d6e63;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        #info-panel {
            width: 90%;
            max-width: 600px;
            text-align: center;
            margin-bottom: 10px;
            min-height: 80px;
        }

        #location-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #bf360c;
            margin-bottom: 5px;
        }

        #location-desc {
            font-size: 0.95rem;
            line-height: 1.4;
        }

        #timeline-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        button {
            background-color: #8d6e63;
            color: white;
            border: none;
            padding: 8px 20px;
            font-family: 'Noto Serif TC', serif;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.3s;
        }

        button:hover {
            background-color: #5d4037;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #progress-bar {
            width: 100%;
            max-width: 600px;
            height: 6px;
            background: #e0e0e0;
            margin-top: 10px;
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        #progress-fill {
            height: 100%;
            background: #bf360c;
            width: 0%;
            transition: width 0.5s ease;
        }

        /* Custom Marker Styles */
        .custom-icon {
            text-align: center;
            color: #bf360c;
            font-weight: bold;
            text-shadow: 1px 1px 0 #fff;
        }
        
        /* Popup Styling */
        .leaflet-popup-content-wrapper {
            border-radius: 4px;
            font-family: 'Noto Serif TC', serif;
        }
        .leaflet-popup-content h3 {
            margin: 5px 0;
            color: #5d4037;
        }
    </style>
</head>
<body>

<header>
    <h1>å®‹å¸å—é€ƒé¦™æ¸¯è·¯ç·šäº’å‹•åœ–</h1>
</header>

<div id="map-container">
    <div id="map"></div>
</div>

<div id="controls">
    <div id="info-panel">
        <div id="location-title">æº–å‚™é–‹å§‹</div>
        <div id="location-desc">é»æ“Šã€Œé–‹å§‹æ—…ç¨‹ã€ä»¥è¿½è¹¤å®‹ç«¯å®—è¶™æ˜°åŠå®‹å¸æ˜ºå—é€ƒè‡³é¦™æ¸¯çš„æ­·å²è¶³è·¡ã€‚</div>
    </div>
    
    <div id="timeline-controls">
        <button id="prev-btn" onclick="prevStep()" disabled>ä¸Šä¸€æ­¥</button>
        <button id="next-btn" onclick="nextStep()">é–‹å§‹æ—…ç¨‹</button>
        <button id="reset-btn" onclick="resetMap()">é‡ç½®</button>
    </div>
    
    <div id="progress-bar">
        <div id="progress-fill"></div>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    // Map Data: Historical locations of the Song Emperor's flight
    const journeyData = [
        {
            id: 0,
            name: "ç¦å»ºç¦å· (Fuzhou)",
            coords: [26.0745, 119.2965],
            year: "1276å¹´ 5æœˆ",
            desc: "ã€èµ·é»ã€‘å—å®‹éƒ½åŸè‡¨å®‰æ·ªé™·å¾Œï¼Œç›Šç‹è¶™æ˜°åœ¨ç¦å·ç™»åŸºï¼Œæ˜¯ç‚ºå®‹ç«¯å®—ã€‚æ”¹å…ƒæ™¯ç‚ï¼Œå±•é–‹æµäº¡ç”Ÿæ¶¯ã€‚",
            zoom: 7
        },
        {
            id: 1,
            name: "ç¦å»ºæ³‰å· (Quanzhou)",
            coords: [24.8741, 118.6757],
            year: "1276å¹´ 11æœˆ",
            desc: "ã€æ‹’ä¹‹é–€å¤–ã€‘å®‹è»æŠµé”æ³‰å·ï¼Œä½†å®ˆå°‡è’²å£½åºšæ‹’çµ•å®‹å¸å…¥åŸã€‚å®‹è»è¢«è¿«æ¶èˆ¹å‡ºæµ·ï¼Œç¹¼çºŒå—é€ƒã€‚",
            zoom: 8
        },
        {
            id: 2,
            name: "å»£æ±æ½®å· (Chaozhou)",
            coords: [23.6569, 116.6235],
            year: "1277å¹´ åˆ",
            desc: "ã€æš«æ³Šå»£æ±ã€‘å®‹å¸ä¸€è¡Œç¶“æµ·è·¯æŠµé”æ½®å·åŠæƒ å·ç”²å­é–€ä¸€å¸¶ï¼Œå…ƒè»ç·Šéš¨å…¶å¾Œã€‚",
            zoom: 8
        },
        {
            id: 3,
            name: "é¦™æ¸¯ æ¢…è”š (Mui Wo/Lantau)",
            coords: [22.2648, 113.9961],
            year: "1277å¹´ 4æœˆ",
            desc: "ã€åˆæŠµé¦™æ¸¯ã€‘å®‹ç«¯å®—ç¶“æµ·è·¯æŠµé”ã€Œæ¢…è”šã€ï¼ˆä»Šå¤§å¶¼å±±æ¢…çª©ä¸€å¸¶ï¼‰ã€‚å‚³èªªå®‹å¸æ›¾åœ¨æ­¤é§ç´®ã€‚",
            zoom: 11
        },
        {
            id: 4,
            name: "ä¹é¾ å®˜å¯Œå ´ (Kowloon City)",
            coords: [22.3242, 114.1896],
            year: "1277å¹´ 4æœˆ - 9æœˆ",
            desc: "ã€å®‹çš‡è‡ºã€‘å®‹å¸éš¨å¾Œç§»å¸«ä¹é¾ã€Œå®˜å¯Œå ´ã€ï¼ˆä»Šä¹é¾åŸï¼‰ã€‚ç›¸å‚³è¶™æ˜°èˆ‡è¶™æ˜ºå¸¸åœ¨æµ·é‚Šå·¨çŸ³ä¼‘æ¯ï¼Œå¾Œäººåˆ»çŸ³ã€Œå®‹ç‹è‡ºã€ç´€å¿µã€‚",
            zoom: 13
        },
        {
            id: 5,
            name: "èƒç£ æ·ºç£ (Tsuen Wan)",
            coords: [22.3699, 114.1144],
            year: "1277å¹´ 9æœˆ",
            desc: "ã€è½‰æˆ°èƒç£ã€‘ç‚ºèº²é¿å…ƒè»ï¼Œå®‹è»è½‰ç§»è‡³ã€Œæ·ºç£ã€ï¼ˆä»Šèƒç£ï¼‰ã€‚ä½†å…ƒå°‡åŠ‰æ·±éš¨å¾Œè¥²æ“Šï¼Œå®‹è»æˆ°æ•—ã€‚",
            zoom: 12
        },
        {
            id: 6,
            name: "å¤§å¶¼å±± (Lantau Island)",
            coords: [22.25, 113.93], // General Lantau area
            year: "1278å¹´",
            desc: "ã€ç«¯å®—é§•å´©ã€‘å®‹è»é€ƒå¾€æ±èè™é–€å¾ŒæŠ˜è¿”å¤§å¶¼å±±ï¼ˆä¸€èªªç¢™å·ï¼‰ã€‚å®‹ç«¯å®—åœ¨æ­¤ç—…é€ï¼Œå¼Ÿè¶™æ˜ºç¹¼ä½ã€‚",
            zoom: 11
        },
        {
            id: 7,
            name: "æ–°æœƒ å´–é–€ (Yamen)",
            coords: [22.1833, 113.0667],
            year: "1279å¹´",
            desc: "ã€æœ€å¾Œä¸€æˆ°ã€‘å®‹è»é€€å®ˆæ–°æœƒå´–é–€ã€‚1279å¹´çˆ†ç™¼å´–å±±æµ·æˆ°ï¼Œå®‹è»å…¨è»è¦†æ²’ï¼Œé™¸ç§€å¤«èƒŒå°‘å¸è¶™æ˜ºæŠ•æµ·æ®‰åœ‹ï¼Œå—å®‹æ»…äº¡ã€‚",
            zoom: 9
        }
    ];

    // Initialize Map
    const map = L.map('map').setView([24.5, 116.0], 6);

    // Add specific tile layer (using CartoDB Voyager for a clean look, or OSM)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    // State
    let currentStep = -1;
    let polylines = [];
    let markers = [];

    // Custom Icons
    const crownIcon = L.divIcon({
        html: '<div style="font-size: 24px;">ğŸ‘‘</div>',
        className: 'custom-icon',
        iconSize: [30, 30],
        iconAnchor: [15, 15]
    });

    const dotIcon = L.divIcon({
        html: '<div style="width: 12px; height: 12px; background: #bf360c; border-radius: 50%; border: 2px solid white;"></div>',
        className: 'custom-icon',
        iconSize: [16, 16],
        iconAnchor: [8, 8]
    });

    const battleIcon = L.divIcon({
        html: '<div style="font-size: 24px;">âš”ï¸</div>',
        className: 'custom-icon',
        iconSize: [30, 30],
        iconAnchor: [15, 15]
    });

    // Helper to add marker
    function addLocationMarker(stepIndex) {
        const data = journeyData[stepIndex];
        let icon = dotIcon;
        if (stepIndex === 0) icon = crownIcon;
        if (stepIndex === 4) icon = crownIcon; // Sung Wong Toi
        if (stepIndex === journeyData.length - 1) icon = battleIcon;

        const marker = L.marker(data.coords, { icon: icon }).addTo(map);
        marker.bindPopup(`<h3>${data.name}</h3><p><b>${data.year}</b></p><p>${data.desc}</p>`).openPopup();
        markers.push(marker);
        return marker;
    }

    // Helper to draw line
    function drawLine(fromIndex, toIndex) {
        const from = journeyData[fromIndex].coords;
        const to = journeyData[toIndex].coords;
        
        const polyline = L.polyline([from, to], {
            color: '#bf360c',
            weight: 4,
            opacity: 0.8,
            dashArray: '5, 10', // Dashed line implies travel
            lineCap: 'round'
        }).addTo(map);
        
        polylines.push(polyline);
    }

    function updateUI(index) {
        const data = journeyData[index];
        document.getElementById('location-title').innerText = `${data.year} - ${data.name}`;
        document.getElementById('location-desc').innerText = data.desc;
        
        // Update progress bar
        const percent = ((index + 1) / journeyData.length) * 100;
        document.getElementById('progress-fill').style.width = `${percent}%`;

        // Update Buttons
        document.getElementById('prev-btn').disabled = (index <= 0);
        document.getElementById('next-btn').innerText = (index >= journeyData.length - 1) ? "æ—…ç¨‹çµæŸ" : "ä¸‹ä¸€æ­¥";
        document.getElementById('next-btn').disabled = (index >= journeyData.length - 1);
    }

    function nextStep() {
        if (currentStep < journeyData.length - 1) {
            currentStep++;
            
            // Draw line from previous if not first
            if (currentStep > 0) {
                drawLine(currentStep - 1, currentStep);
            }

            // Add marker
            const marker = addLocationMarker(currentStep);
            
            // Move map
            map.flyTo(journeyData[currentStep].coords, journeyData[currentStep].zoom, {
                duration: 1.5
            });

            updateUI(currentStep);
        }
    }

    function prevStep() {
        if (currentStep > 0) {
            // Remove current marker
            const markerToRemove = markers.pop();
            map.removeLayer(markerToRemove);

            // Remove line to current
            const lineToRemove = polylines.pop();
            map.removeLayer(lineToRemove);

            currentStep--;
            
            // Move map back
            map.flyTo(journeyData[currentStep].coords, journeyData[currentStep].zoom, {
                duration: 1.5
            });

            updateUI(currentStep);
        }
    }

    function resetMap() {
        // Clear all layers
        markers.forEach(m => map.removeLayer(m));
        polylines.forEach(p => map.removeLayer(p));
        markers = [];
        polylines = [];
        currentStep = -1;
        
        // Reset UI
        document.getElementById('location-title').innerText = "æº–å‚™é–‹å§‹";
        document.getElementById('location-desc').innerText = "é»æ“Šã€Œé–‹å§‹æ—…ç¨‹ã€ä»¥è¿½è¹¤å®‹ç«¯å®—è¶™æ˜°åŠå®‹å¸æ˜ºå—é€ƒè‡³é¦™æ¸¯çš„æ­·å²è¶³è·¡ã€‚";
        document.getElementById('progress-fill').style.width = "0%";
        document.getElementById('prev-btn').disabled = true;
        document.getElementById('next-btn').innerText = "é–‹å§‹æ—…ç¨‹";
        document.getElementById('next-btn').disabled = false;
        
        map.setView([24.5, 116.0], 6);
    }

</script>

</body>
</html>
