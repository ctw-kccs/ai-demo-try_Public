<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Forms & Changes Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom Scrollbar for Chat */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Animation Classes */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        canvas {
            touch-action: none; /* Prevent scrolling on canvas touch */
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between shadow-sm z-10 shrink-0">
        <div class="flex items-center gap-2">
            <i data-lucide="activity" class="text-blue-600"></i>
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">Energy Forms & Changes</h1>
        </div>
        <div class="flex items-center gap-4">
            <button id="btn-ai-tutor" class="flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-bold transition-all shadow-sm bg-white text-indigo-600 border border-indigo-200 hover:bg-indigo-50">
                <i data-lucide="sparkles" class="w-4 h-4"></i>
                AI Tutor
            </button>
            <button id="btn-toggle-symbols" class="flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium transition-colors bg-blue-100 text-blue-700">
                <div class="w-4 h-4 rounded-full bg-blue-500 text-white flex items-center justify-center text-xs font-bold">E</div>
                Energy Symbols
            </button>
            <button id="btn-play-pause" class="p-2 hover:bg-slate-100 rounded-full text-slate-600">
                <i data-lucide="pause" class="w-5 h-5"></i>
            </button>
            <button id="btn-reset" class="p-2 hover:bg-slate-100 rounded-full text-slate-600">
                <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 relative overflow-hidden flex flex-col md:flex-row h-full">
        
        <!-- Controls Sidebar -->
        <aside class="w-full md:w-80 bg-white border-r border-slate-200 p-6 flex flex-col gap-8 overflow-y-auto shadow-lg z-10 h-full shrink-0">
            
            <!-- Input Slider -->
            <div class="space-y-3 p-4 bg-slate-50 rounded-xl border border-slate-100">
                <div class="flex justify-between items-center">
                    <label class="font-semibold text-sm text-slate-600">Input Intensity</label>
                    <span id="intensity-display" class="text-xs font-mono bg-white px-2 py-1 rounded border">50%</span>
                </div>
                <input id="input-intensity" type="range" min="0" max="100" value="50" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                <p class="text-xs text-slate-500">Controls how fast the cyclist pedals, sun brightness, or fire heat.</p>
            </div>

            <!-- Selection Groups -->
            <div class="space-y-6">
                <!-- Source -->
                <div class="space-y-2">
                    <h3 class="text-xs font-bold uppercase tracking-wider text-slate-400">Energy Source</h3>
                    <div class="grid grid-cols-3 gap-2" id="source-options">
                        <!-- Buttons injected by JS -->
                    </div>
                </div>

                <!-- Converter -->
                <div class="space-y-2">
                    <h3 class="text-xs font-bold uppercase tracking-wider text-slate-400">Converter</h3>
                    <div class="grid grid-cols-2 gap-2" id="converter-options">
                        <!-- Buttons injected by JS -->
                    </div>
                </div>

                <!-- Output -->
                <div class="space-y-2">
                    <h3 class="text-xs font-bold uppercase tracking-wider text-slate-400">Output</h3>
                    <div class="grid grid-cols-3 gap-2" id="output-options">
                        <!-- Buttons injected by JS -->
                    </div>
                </div>
            </div>

            <!-- Legend -->
            <div class="mt-auto pt-6 border-t border-slate-100">
                <h3 class="text-xs font-bold uppercase tracking-wider text-slate-400 mb-3">Energy Legend</h3>
                <div class="grid grid-cols-2 gap-2 text-xs" id="legend-container">
                    <!-- Legend items injected by JS -->
                </div>
            </div>
        </aside>

        <!-- Canvas Area -->
        <div class="flex-1 bg-slate-50 relative h-full w-full">
            <canvas id="sim-canvas" class="w-full h-full object-contain block touch-none"></canvas>
            
            <!-- Overlay Tips -->
            <div id="status-overlay" class="absolute bottom-4 right-4 bg-white/80 backdrop-blur px-4 py-2 rounded-lg shadow text-xs text-slate-500 pointer-events-none transition-all duration-300">
                <span class="text-green-600 flex items-center gap-2">‚úì System Connected</span>
            </div>
        </div>

    </main>

    <!-- AI Tutor Panel (Hidden by default) -->
    <div id="ai-tutor-panel" class="hidden absolute right-4 bottom-4 w-96 h-[500px] bg-white rounded-2xl shadow-2xl flex-col border border-indigo-100 z-50 animate-fade-in flex">
        <!-- Header -->
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-4 rounded-t-2xl flex justify-between items-center text-white shrink-0">
            <div class="flex items-center gap-2">
                <div class="p-1.5 bg-white/20 rounded-lg">
                    <i data-lucide="bot" class="text-white w-5 h-5"></i>
                </div>
                <span class="font-bold">Science Tutor</span>
            </div>
            <button id="btn-close-ai" class="hover:bg-white/20 p-1 rounded-full transition-colors">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>

        <!-- Messages -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
            <div class="flex justify-start">
                <div class="max-w-[85%] p-3 rounded-2xl text-sm leading-relaxed shadow-sm bg-white text-slate-700 border border-slate-200 rounded-tl-sm">
                    Hi! I'm your Energy Science Buddy. ‚ú® I see you're experimenting! Ask me to explain the current system or why something isn't working.
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="px-4 py-2 bg-white border-t border-slate-100 flex gap-2 overflow-x-auto no-scrollbar shrink-0">
            <button class="quick-action-btn whitespace-nowrap px-3 py-1 bg-amber-50 text-amber-700 text-xs rounded-full border border-amber-200 hover:bg-amber-100 transition-colors" data-query="Why isn't this working?">
                ‚ö†Ô∏è Why is it broken?
            </button>
            <button class="quick-action-btn whitespace-nowrap px-3 py-1 bg-blue-50 text-blue-700 text-xs rounded-full border border-blue-200 hover:bg-blue-100 transition-colors" data-query="Explain the energy transformation here.">
                üîÑ Explain Energy Flow
            </button>
            <button class="quick-action-btn whitespace-nowrap px-3 py-1 bg-purple-50 text-purple-700 text-xs rounded-full border border-purple-200 hover:bg-purple-100 transition-colors" data-query="Give me a fun challenge to build!">
                üéØ Quiz Me
            </button>
        </div>

        <!-- Input -->
        <div class="p-3 bg-white border-t border-slate-200 rounded-b-2xl shrink-0">
            <div class="flex gap-2">
                <input id="chat-input" type="text" placeholder="Ask a physics question..." class="flex-1 bg-slate-100 border-0 rounded-full px-4 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                <button id="btn-send-chat" class="p-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition-colors shadow-sm disabled:opacity-50">
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Constants ---
        const apiKey = ""; // API Key injected by environment

        const ENERGY_TYPES = {
            MECHANICAL: { color: '#9ca3af', label: 'Mechanical', icon: '‚öôÔ∏è' },
            ELECTRICAL: { color: '#3b82f6', label: 'Electrical', icon: '‚ö°' },
            THERMAL: { color: '#ef4444', label: 'Thermal', icon: 'üî•' },
            LIGHT: { color: '#eab308', label: 'Light', icon: '‚òÄÔ∏è' },
            CHEMICAL: { color: '#22c55e', label: 'Chemical', icon: 'üçè' },
        };

        const COMPONENT_TYPES = {
            SOURCE: { CYCLIST: 'cyclist', SUN: 'sun', KETTLE: 'kettle' },
            CONVERTER: { GENERATOR: 'generator', SOLAR_PANEL: 'solar_panel' },
            OUTPUT: { BULB: 'bulb', FAN: 'fan', HEATER: 'heater' }
        };

        const COMPONENT_ICONS = {
            cyclist: 'üö¥', sun: '‚òÄÔ∏è', kettle: 'ü´ñ',
            generator: '‚öôÔ∏è', solar_panel: '‚ñ¶',
            bulb: 'üí°', fan: 'üí®', heater: 'üî•'
        };

        const POS = {
            SOURCE: { x: 0.15, y: 0.6 },
            CONVERTER: { x: 0.5, y: 0.6 },
            OUTPUT: { x: 0.85, y: 0.6 }
        };

        // --- State ---
        let state = {
            source: COMPONENT_TYPES.SOURCE.CYCLIST,
            converter: COMPONENT_TYPES.CONVERTER.GENERATOR,
            output: COMPONENT_TYPES.OUTPUT.BULB,
            isPlaying: true,
            showSymbols: true,
            inputIntensity: 50,
            showAI: false,
            particles: [],
            time: 0
        };

        // --- Initialization ---
        const canvas = document.getElementById('sim-canvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // --- Helper Functions ---
        const randomRange = (min, max) => Math.random() * (max - min) + min;

        // --- UI Rendering Helpers ---
        function renderSelectionButtons() {
            const createBtn = (id, type, current, group, label) => {
                const isActive = current === type;
                const icon = COMPONENT_ICONS[type];
                return `
                    <button onclick="setComponent('${group}', '${type}')" 
                        class="flex flex-col items-center justify-center p-3 rounded-xl border transition-all duration-200 ${isActive ? 'bg-blue-50 border-blue-500 shadow-sm ring-1 ring-blue-500/20 text-blue-700' : 'bg-white border-slate-200 hover:border-blue-300 hover:bg-slate-50 text-slate-600'}">
                        <span class="text-2xl mb-1 filter drop-shadow-sm">${icon}</span>
                        <span class="text-xs font-medium">${label}</span>
                    </button>
                `;
            };

            const sourceHTML = Object.entries(COMPONENT_TYPES.SOURCE).map(([k, v]) => createBtn(k, v, state.source, 'source', v.charAt(0).toUpperCase() + v.slice(1))).join('');
            document.getElementById('source-options').innerHTML = sourceHTML;

            const converterHTML = Object.entries(COMPONENT_TYPES.CONVERTER).map(([k, v]) => createBtn(k, v, state.converter, 'converter', v.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()))).join('');
            document.getElementById('converter-options').innerHTML = converterHTML;

            const outputHTML = Object.entries(COMPONENT_TYPES.OUTPUT).map(([k, v]) => createBtn(k, v, state.output, 'output', v.charAt(0).toUpperCase() + v.slice(1))).join('');
            document.getElementById('output-options').innerHTML = outputHTML;
        }

        function renderLegend() {
            const html = Object.values(ENERGY_TYPES).map(t => `
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full" style="background-color: ${t.color}"></span>
                    <span class="text-slate-600">${t.label}</span>
                </div>
            `).join('');
            document.getElementById('legend-container').innerHTML = html;
        }

        // --- State Setters ---
        window.setComponent = (group, type) => {
            state[group] = type;
            renderSelectionButtons(); // Re-render to update active state
            updateStatusOverlay();
        };

        // --- Simulation Logic ---

        function spawnParticle(type, x, y, vx, vy) {
            state.particles.push({
                x, y, vx, vy, type,
                life: 1.0,
                id: Math.random().toString(36).substr(2, 9)
            });
        }

        function drawComponent(type, x, y, width, height, time, active) {
            const scale = width / 100;
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(scale, scale);

            // Common Styles
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            switch (type) {
                case COMPONENT_TYPES.SOURCE.CYCLIST:
                    ctx.strokeStyle = '#374151';
                    ctx.beginPath();
                    ctx.moveTo(-30, -20); ctx.lineTo(0, 20); ctx.lineTo(30, -20); ctx.lineTo(-10, -20);
                    ctx.moveTo(0, 20); ctx.lineTo(20, -40); 
                    ctx.stroke();
                    
                    ctx.save();
                    ctx.translate(-30, 20);
                    if (active) ctx.rotate(-time * 5);
                    ctx.beginPath();
                    ctx.arc(0, 0, 20, 0, Math.PI * 2);
                    ctx.moveTo(0, -20); ctx.lineTo(0, 20);
                    ctx.moveTo(-20, 0); ctx.lineTo(20, 0);
                    ctx.stroke();
                    ctx.restore();

                    ctx.beginPath();
                    ctx.arc(30, 20, 20, 0, Math.PI * 2);
                    ctx.stroke();

                    ctx.strokeStyle = '#ef4444';
                    ctx.beginPath();
                    ctx.moveTo(20, -40); ctx.lineTo(0, -10);
                    ctx.stroke();
                    ctx.fillStyle = '#fca5a5';
                    ctx.beginPath();
                    ctx.arc(20, -50, 8, 0, Math.PI * 2);
                    ctx.fill();
                    break;

                case COMPONENT_TYPES.SOURCE.SUN:
                    ctx.fillStyle = '#fbbf24';
                    ctx.strokeStyle = '#f59e0b';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(0, -20, 30, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    if (active) {
                        ctx.beginPath();
                        for(let i=0; i<8; i++) {
                            const angle = (time * 0.5) + (i * Math.PI / 4);
                            ctx.moveTo(Math.cos(angle) * 35, Math.sin(angle) * 35 - 20);
                            ctx.lineTo(Math.cos(angle) * (45 + Math.sin(time * 5) * 5), Math.sin(angle) * (45 + Math.sin(time * 5) * 5) - 20);
                        }
                        ctx.stroke();
                    }
                    break;
                
                case COMPONENT_TYPES.SOURCE.KETTLE:
                    ctx.fillStyle = '#d1d5db';
                    ctx.strokeStyle = '#4b5563';
                    ctx.beginPath();
                    ctx.arc(0, 0, 30, 0, Math.PI, false);
                    ctx.bezierCurveTo(-30, -30, 30, -30, 30, 0);
                    ctx.fill();
                    ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(-30, 0); ctx.bezierCurveTo(-50, -30, -20, -50, 0, -30); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(25, -10); ctx.lineTo(45, -20); ctx.stroke();
                    if (active) {
                        ctx.fillStyle = '#ef4444';
                        ctx.beginPath(); ctx.moveTo(-15, 35); ctx.lineTo(0, 15 + Math.sin(time * 10)*5); ctx.lineTo(15, 35); ctx.fill();
                        ctx.strokeStyle = 'rgba(255,255,255,0.6)'; ctx.lineWidth = 4; ctx.beginPath();
                        ctx.moveTo(45, -20); ctx.bezierCurveTo(55, -40, 35, -60, 65, -80); ctx.stroke();
                    }
                    break;

                case COMPONENT_TYPES.CONVERTER.GENERATOR:
                    ctx.fillStyle = '#6b7280'; ctx.fillRect(-25, -25, 50, 50);
                    ctx.strokeStyle = '#d1d5db'; ctx.lineWidth = 4; ctx.beginPath(); ctx.arc(-35, 0, 20, 0, Math.PI * 2); ctx.stroke();
                    ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 2; ctx.beginPath();
                    ctx.moveTo(-15, -15); ctx.lineTo(15, -15); ctx.moveTo(-15, 0); ctx.lineTo(15, 0); ctx.moveTo(-15, 15); ctx.lineTo(15, 15); ctx.stroke();
                    if (active) {
                        ctx.save(); ctx.translate(-35, 0); ctx.rotate(time * 8); ctx.strokeStyle = '#000';
                        ctx.beginPath(); ctx.moveTo(-20, 0); ctx.lineTo(20, 0); ctx.moveTo(0, -20); ctx.lineTo(0, 20); ctx.stroke(); ctx.restore();
                    }
                    break;

                case COMPONENT_TYPES.CONVERTER.SOLAR_PANEL:
                    ctx.fillStyle = '#1e3a8a'; ctx.strokeStyle = '#60a5fa';
                    ctx.beginPath(); ctx.moveTo(-40, 20); ctx.lineTo(40, 20); ctx.lineTo(30, -20); ctx.lineTo(-30, -20); ctx.closePath(); ctx.fill(); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(0, 20); ctx.lineTo(0, -20); ctx.moveTo(-20, 20); ctx.lineTo(-15, -20); ctx.moveTo(20, 20); ctx.lineTo(15, -20);
                    ctx.moveTo(-35, 0); ctx.lineTo(35, 0); ctx.stroke();
                    break;

                case COMPONENT_TYPES.OUTPUT.BULB:
                    ctx.fillStyle = '#9ca3af'; ctx.fillRect(-10, 20, 20, 15);
                    ctx.fillStyle = active ? 'rgba(253, 224, 71, 0.8)' : 'rgba(255, 255, 255, 0.3)';
                    ctx.strokeStyle = active ? '#eab308' : '#d1d5db';
                    ctx.beginPath(); ctx.arc(0, 0, 25, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                    if (active) { ctx.shadowBlur = 30; ctx.shadowColor = '#eab308'; ctx.stroke(); ctx.shadowBlur = 0; }
                    break;

                case COMPONENT_TYPES.OUTPUT.FAN:
                    ctx.strokeStyle = '#4b5563'; ctx.lineWidth = 4; ctx.beginPath(); ctx.moveTo(0, 40); ctx.lineTo(0, 0); ctx.moveTo(-20, 40); ctx.lineTo(20, 40); ctx.stroke();
                    ctx.save(); if (active) ctx.rotate(time * 15); ctx.fillStyle = '#0ea5e9';
                    for(let i=0; i<3; i++) { ctx.rotate((Math.PI * 2) / 3); ctx.beginPath(); ctx.ellipse(0, -20, 10, 25, 0, 0, Math.PI * 2); ctx.fill(); }
                    ctx.restore();
                    ctx.fillStyle = '#1f2937'; ctx.beginPath(); ctx.arc(0, 0, 5, 0, Math.PI * 2); ctx.fill();
                    break;

                case COMPONENT_TYPES.OUTPUT.HEATER:
                    ctx.fillStyle = '#fee2e2'; ctx.strokeStyle = '#ef4444'; ctx.fillRect(-25, -20, 50, 60); ctx.strokeRect(-25, -20, 50, 60);
                    ctx.strokeStyle = active ? '#ef4444' : '#9ca3af';
                    if (active) { ctx.shadowColor = '#ef4444'; ctx.shadowBlur = 10; }
                    ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(-20, 0);
                    for(let i=0; i<4; i++) { ctx.lineTo(20, 0 + i*10); ctx.lineTo(-20, 0 + i*10 + 5); }
                    ctx.stroke(); ctx.shadowBlur = 0;
                    if (active) {
                        ctx.fillStyle = 'rgba(59, 130, 246, 0.3)'; ctx.fillRect(-25, -20, 50, 30);
                        ctx.fillStyle = 'rgba(255,255,255,0.5)';
                        if (Math.random() > 0.8) { ctx.beginPath(); ctx.arc(randomRange(-20, 20), randomRange(-15, 5), 2, 0, Math.PI*2); ctx.fill(); }
                    }
                    break;
            }
            ctx.restore();
        }

        function updateSimulation() {
            const width = canvas.width;
            const height = canvas.height;
            const intensity = state.inputIntensity / 100;

            ctx.clearRect(0, 0, width, height);
            
            // Background
            ctx.fillStyle = '#f3f4f6'; ctx.fillRect(0, 0, width, height);
            ctx.fillStyle = '#e5e7eb'; ctx.fillRect(0, height * 0.7, width, height * 0.3);

            if (state.isPlaying) state.time += 0.016;

            // Compatibility Logic
            let sourceActive = intensity > 0;
            let converterActive = false;
            let outputActive = false;

            let sourceEnergyType = null;
            if (state.source === COMPONENT_TYPES.SOURCE.CYCLIST) sourceEnergyType = ENERGY_TYPES.MECHANICAL;
            if (state.source === COMPONENT_TYPES.SOURCE.SUN) sourceEnergyType = ENERGY_TYPES.LIGHT;
            if (state.source === COMPONENT_TYPES.SOURCE.KETTLE) sourceEnergyType = ENERGY_TYPES.MECHANICAL;

            let converterInputType = null;
            let converterOutputType = null;
            if (state.converter === COMPONENT_TYPES.CONVERTER.GENERATOR) {
                converterInputType = ENERGY_TYPES.MECHANICAL;
                converterOutputType = ENERGY_TYPES.ELECTRICAL;
            } else if (state.converter === COMPONENT_TYPES.CONVERTER.SOLAR_PANEL) {
                converterInputType = ENERGY_TYPES.LIGHT;
                converterOutputType = ENERGY_TYPES.ELECTRICAL;
            }

            if (sourceActive && sourceEnergyType === converterInputType) {
                converterActive = true;
            }
            if (converterActive && converterOutputType === ENERGY_TYPES.ELECTRICAL) {
                outputActive = true;
            }

            // Positions
            const sX = width * POS.SOURCE.x; const sY = height * POS.SOURCE.y;
            const cX = width * POS.CONVERTER.x; const cY = height * POS.CONVERTER.y;
            const oX = width * POS.OUTPUT.x; const oY = height * POS.OUTPUT.y;

            // Wires/Belts
            ctx.beginPath(); ctx.strokeStyle = '#4b5563'; ctx.lineWidth = 4;
            if (state.source === COMPONENT_TYPES.SOURCE.CYCLIST && state.converter === COMPONENT_TYPES.CONVERTER.GENERATOR) {
                ctx.strokeStyle = '#1f2937'; ctx.lineWidth = 3;
                ctx.moveTo(sX, sY + 20); ctx.lineTo(cX - 35, cY); ctx.stroke();
                if (sourceActive) {
                    ctx.setLineDash([5, 5]); ctx.lineDashOffset = -state.time * 50; ctx.stroke(); ctx.setLineDash([]);
                }
            } else if (converterActive) {
                ctx.strokeStyle = '#d97706'; ctx.lineWidth = 3; ctx.beginPath();
                ctx.moveTo(cX + 20, cY + 10); ctx.lineTo(oX - 10, oY + 20); ctx.stroke();
            }

            // Draw Components
            drawComponent(state.source, sX, sY, 150, 150, state.time, sourceActive);
            drawComponent(state.converter, cX, cY, 150, 150, state.time, converterActive);
            drawComponent(state.output, oX, oY, 150, 150, state.time, outputActive);

            // Particles
            if (state.isPlaying) {
                if (sourceActive && Math.random() < 0.05 * intensity) {
                    let spawnType = null;
                    if (state.source === COMPONENT_TYPES.SOURCE.CYCLIST) spawnType = ENERGY_TYPES.CHEMICAL;
                    if (state.source === COMPONENT_TYPES.SOURCE.SUN) spawnType = ENERGY_TYPES.LIGHT;
                    if (state.source === COMPONENT_TYPES.SOURCE.KETTLE) spawnType = ENERGY_TYPES.THERMAL;
                    spawnParticle(spawnType, sX - 20, sY - 40 + randomRange(-10, 10), 2, randomRange(-0.5, 0.5));
                }

                state.particles.forEach(p => {
                    p.x += p.vx; p.y += p.vy; p.life -= 0.002;

                    // Zone 1: Source
                    if (state.source === COMPONENT_TYPES.SOURCE.CYCLIST && p.type === ENERGY_TYPES.CHEMICAL && p.x > sX) p.type = ENERGY_TYPES.MECHANICAL;
                    else if (state.source === COMPONENT_TYPES.SOURCE.KETTLE && p.type === ENERGY_TYPES.THERMAL && p.x > sX + 30) {
                        p.type = ENERGY_TYPES.MECHANICAL; p.vy = randomRange(-1, 0);
                    }

                    // Zone 2: Converter
                    if (Math.abs(p.x - cX) < 30 && Math.abs(p.y - cY) < 60) {
                        if (state.converter === COMPONENT_TYPES.CONVERTER.GENERATOR) {
                            if (p.type === ENERGY_TYPES.MECHANICAL) { p.type = ENERGY_TYPES.ELECTRICAL; p.vx = 3; p.y = cY + randomRange(-5, 5); }
                            else if (p.type === ENERGY_TYPES.LIGHT) p.life = 0;
                        }
                        if (state.converter === COMPONENT_TYPES.CONVERTER.SOLAR_PANEL) {
                            if (p.type === ENERGY_TYPES.LIGHT) { p.type = ENERGY_TYPES.ELECTRICAL; p.vx = 3; p.y = cY; }
                            else if (p.type === ENERGY_TYPES.MECHANICAL) p.life = 0;
                        }
                    }

                    // Zone 3: Output
                    if (Math.abs(p.x - oX) < 20 && Math.abs(p.y - oY) < 50 && p.type === ENERGY_TYPES.ELECTRICAL) {
                        if (state.output === COMPONENT_TYPES.OUTPUT.BULB) {
                            p.type = Math.random() > 0.3 ? ENERGY_TYPES.LIGHT : ENERGY_TYPES.THERMAL;
                            p.vx = randomRange(-1, 1); p.vy = randomRange(-1, 1);
                        } else if (state.output === COMPONENT_TYPES.OUTPUT.FAN) {
                            p.type = ENERGY_TYPES.MECHANICAL; p.vx = 4; p.vy = randomRange(-2, 2);
                        } else if (state.output === COMPONENT_TYPES.OUTPUT.HEATER) {
                            p.type = ENERGY_TYPES.THERMAL; p.vx = randomRange(-0.5, 0.5); p.vy = -2;
                        }
                    }
                });
                state.particles = state.particles.filter(p => p.life > 0 && p.x < width + 50);
            }

            // Draw Particles
            if (state.showSymbols) {
                state.particles.forEach(p => {
                    ctx.fillStyle = p.type.color;
                    ctx.beginPath(); ctx.arc(p.x, p.y, 9, 0, Math.PI * 2); ctx.fill();
                    ctx.fillStyle = '#fff'; ctx.font = 'bold 16px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    ctx.fillText('E', p.x, p.y);
                });
            }

            requestAnimationFrame(updateSimulation);
        }

        function updateStatusOverlay() {
            const overlay = document.getElementById('status-overlay');
            let msg = '';
            
            // Re-calc basic compatibility
            let sourceMech = (state.source === COMPONENT_TYPES.SOURCE.CYCLIST || state.source === COMPONENT_TYPES.SOURCE.KETTLE);
            let sourceLight = (state.source === COMPONENT_TYPES.SOURCE.SUN);
            let convMech = (state.converter === COMPONENT_TYPES.CONVERTER.GENERATOR);
            let convLight = (state.converter === COMPONENT_TYPES.CONVERTER.SOLAR_PANEL);

            if (sourceLight && convMech) msg = '<span class="text-amber-600 flex items-center gap-2">‚ö†Ô∏è Sun light cannot spin a generator directly!</span>';
            else if (sourceMech && convLight) msg = '<span class="text-amber-600 flex items-center gap-2">‚ö†Ô∏è Mechanical motion cannot power a solar panel!</span>';
            else msg = '<span class="text-green-600 flex items-center gap-2">‚úì System Connected</span>';
            
            overlay.innerHTML = msg;
        }

        // --- Event Listeners ---
        document.getElementById('input-intensity').addEventListener('input', (e) => {
            state.inputIntensity = parseInt(e.target.value);
            document.getElementById('intensity-display').innerText = state.inputIntensity + '%';
        });

        document.getElementById('btn-play-pause').addEventListener('click', () => {
            state.isPlaying = !state.isPlaying;
            document.querySelector('#btn-play-pause i').setAttribute('data-lucide', state.isPlaying ? 'pause' : 'play');
            lucide.createIcons();
        });

        document.getElementById('btn-toggle-symbols').addEventListener('click', (e) => {
            state.showSymbols = !state.showSymbols;
            const btn = e.currentTarget;
            if (state.showSymbols) {
                btn.className = "flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium transition-colors bg-blue-100 text-blue-700";
            } else {
                btn.className = "flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium transition-colors bg-slate-100 text-slate-600";
            }
        });

        document.getElementById('btn-reset').addEventListener('click', () => {
            state.particles = [];
            state.time = 0;
        });

        // --- AI Tutor Logic ---
        const tutorPanel = document.getElementById('ai-tutor-panel');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');

        document.getElementById('btn-ai-tutor').addEventListener('click', () => {
            state.showAI = !state.showAI;
            if (state.showAI) {
                tutorPanel.classList.remove('hidden');
                document.getElementById('btn-ai-tutor').classList.replace('bg-white', 'bg-indigo-600');
                document.getElementById('btn-ai-tutor').classList.replace('text-indigo-600', 'text-white');
            } else {
                tutorPanel.classList.add('hidden');
                document.getElementById('btn-ai-tutor').classList.replace('bg-indigo-600', 'bg-white');
                document.getElementById('btn-ai-tutor').classList.replace('text-white', 'text-indigo-600');
            }
        });

        document.getElementById('btn-close-ai').addEventListener('click', () => {
            state.showAI = false;
            tutorPanel.classList.add('hidden');
            document.getElementById('btn-ai-tutor').classList.replace('bg-indigo-600', 'bg-white');
            document.getElementById('btn-ai-tutor').classList.replace('text-white', 'text-indigo-600');
        });

        // Gemini Call
        async function callGemini(userQuery) {
            // Construct Context
            let sourceEnergy = (state.source === 'sun') ? 'LIGHT' : 'MECHANICAL/THERMAL';
            let converterRequires = (state.converter === 'solar_panel') ? 'LIGHT' : 'MECHANICAL';
            
            const context = {
                source: state.source,
                sourceType: sourceEnergy,
                converter: state.converter,
                converterRequires: converterRequires,
                output: state.output,
                inputIntensity: state.inputIntensity
            };

            const systemInstruction = `
                You are an enthusiastic and helpful Science Tutor inside an interactive "Energy Forms & Changes" simulation for students.
                CURRENT SIMULATION STATE: ${JSON.stringify(context)}
                YOUR ROLE:
                1. Analyze the user's current setup.
                2. Explain why it works or fails based on physics.
                3. Keep answers concise (max 3 sentences), encouraging, and fun. Use emojis.
            `;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };

            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }
                );
                if (!response.ok) throw new Error('API Fail');
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "I'm pondering... try again!";
            } catch (e) {
                return "My brain circuits are fuzzy. Check network connection.";
            }
        }

        async function handleChat(text) {
            if (!text.trim()) return;
            
            // Add User Message
            addMessage(text, 'user');
            chatInput.value = '';

            // Loading
            const loadingId = addMessage('Thinking...', 'assistant', true);

            // Call API
            const response = await callGemini(text);
            
            // Remove Loading, Add Response
            document.getElementById(loadingId).remove();
            addMessage(response, 'assistant');
        }

        function addMessage(text, role, isLoading = false) {
            const id = 'msg-' + Math.random().toString(36).substr(2, 9);
            const isUser = role === 'user';
            const div = document.createElement('div');
            div.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
            div.id = id;
            
            const bubble = document.createElement('div');
            bubble.className = `max-w-[85%] p-3 rounded-2xl text-sm leading-relaxed shadow-sm ${
                isUser 
                ? 'bg-indigo-600 text-white rounded-tr-sm' 
                : 'bg-white text-slate-700 border border-slate-200 rounded-tl-sm'
            }`;
            
            if (isLoading) {
                bubble.innerHTML = `<div class="flex items-center gap-2"><i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> Thinking...</div>`;
            } else {
                bubble.innerText = text;
            }

            div.appendChild(bubble);
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            if(isLoading) lucide.createIcons();
            return id;
        }

        document.getElementById('btn-send-chat').addEventListener('click', () => handleChat(chatInput.value));
        chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleChat(chatInput.value); });
        
        document.querySelectorAll('.quick-action-btn').forEach(btn => {
            btn.addEventListener('click', () => handleChat(btn.dataset.query));
        });

        // --- Init ---
        renderSelectionButtons();
        renderLegend();
        lucide.createIcons();
        updateSimulation();

    </script>
</body>
</html>
